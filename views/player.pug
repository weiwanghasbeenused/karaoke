doctype html
html
    include includes/head.pug
    body.viewing-auth-youtube-mask
        div#auth-youtube-mask.viewport-mask.full-vh.full-vw
            div#auth-youtube-btn.btn 點我開始
        main
            div#karaoke-container
            
        script(src="/js/KaraokePlayer.js")
        script(src="/js/WS.js")
        script(src="https://apis.google.com/js/api.js")
        script.
            let sKaraoke_container = document.getElementById('karaoke-container');
            const kplayer = new KaraokePlayer(sKaraoke_container);
            function onYouTubeIframeAPIReady() {
                for(let i = 0; i < kplayer.player_num; i++) {
                    kplayer.players[i] = new YT.Player('player-' + (i + 1), {
                        height: '100%',
                        width: '100%',
                        events: {
                            'onReady': kplayer.onPlayerReady.bind(kplayer),
                            'onStateChange': kplayer.onPlayerStateChange.bind(kplayer)
                        }
                    });
                }
            }
            /* websocket */
            const ws = new KaraokeWS('!{host}');
            ws.onMessage(function(event){
                if(!kplayer.isReady) return;
                let message = JSON.parse(event.data);
                if(message.type === 'book')
                    kplayer.book(message.body);
            });

            /**
            * Sample JavaScript code for youtube.videos.list
            * See instructions for running APIs Explorer code samples locally:
            * https://developers.google.com/explorer-help/code-samples#javascript
            */
            console.log('!{YOUTUBE_API_KEY}')
            console.log('!{YOUTUBE_CLIENT_ID}')
            function authenticate() {
                return gapi.auth2.getAuthInstance()
                    .signIn({scope: "https://www.googleapis.com/auth/youtube.readonly"})
                    .then(function() { console.log("Sign-in successful"); },
                        function(err) { console.error("Error signing in", err); });
            }
            function loadClient() {
                gapi.client.setApiKey('!{YOUTUBE_API_KEY}');
                return gapi.client.load("https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest")
                    .then(function() { console.log("GAPI client loaded for API"); 
                        kplayer.gapi = gapi;
                        document.body.classList.remove('viewing-auth-youtube-mask');
                    }, function(err) { console.error("Error loading GAPI client for API", err); });
            }
            // Make sure the client is loaded and sign-in is complete before calling this method.
            function execute() {
                return gapi.client.youtube.videos.list({
                "part": [
                    "snippet,contentDetails,statistics"
                ],
                "id": [
                    "26MuLZUQRn8"
                ]
                })
                    .then(function(response) {
                            // Handle the results here (response.result has the parsed body).
                            console.log("Response", response);
                        },
                        function(err) { console.error("Execute error", err); });
            }
            gapi.load("client:auth2", function() {
                gapi.auth2.init({client_id: '!{YOUTUBE_CLIENT_ID}'});
            });
            const sAuth_youtube_btn = document.getElementById('auth-youtube-btn');
            sAuth_youtube_btn.addEventListener('click', () => authenticate().then(loadClient));
